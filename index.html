<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>تطبيق صناعة الناي والكولة - تسجيل فيديو/صوت</title>
  <style>
    /* إعداد متغيرات الألوان */
    :root {
      --main-bg: #222;
      --accent: #ffd700;
      --text-color: #fff;
      --input-bg: #333;
      --input-border: #444;
      --hover-bg: #e6c200;
      --active-bg: #d4af37;
    }
    /* إعادة تعيين الأنماط الأساسية */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(45deg, #000, #222, #444, #000);
      background-size: 400% 400%;
      animation: gradientBG 10s ease infinite;
      color: var(--text-color);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      direction: rtl;
    }
    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .container {
      background-color: var(--main-bg);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.7);
      width: 100%;
      max-width: 1000px;
      animation: fadeInUp 1s ease-out;
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .tabs {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }
    .tab-button {
      background-color: var(--input-bg);
      color: var(--text-color);
      border: none;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 5px;
      transition: background 0.3s ease;
    }
    .tab-button.active {
      background-color: var(--accent);
      color: #000;
    }
    .tab-button:hover {
      background-color: var(--hover-bg);
      animation: shake 0.5s ease-in-out;
    }
    @keyframes shake {
      0% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      50% { transform: translateX(5px); }
      75% { transform: translateX(-5px); }
      100% { transform: translateX(0); }
    }
    .tab-content {
      display: none;
      animation: fadeInUp 0.5s ease-out;
    }
    .tab-content.active {
      display: block;
    }
    .section-header {
      font-size: 22px;
      margin-bottom: 10px;
      color: var(--accent);
      text-align: center;
    }
    label {
      font-size: 16px;
      margin-bottom: 5px;
      display: block;
    }
    .tooltip {
      font-size: 14px;
      color: #aaa;
      margin-bottom: 10px;
    }
    input[type="number"],
    select {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border: 1px solid var(--input-border);
      border-radius: 5px;
      background-color: var(--input-bg);
      color: var(--text-color);
      transition: background-color 0.3s ease, border 0.3s ease;
      margin-bottom: 15px;
    }
    input[type="number"]:focus,
    select:focus {
      background-color: #444;
      border-color: var(--accent);
      outline: none;
    }
    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    button {
      background-color: var(--accent);
      color: #000;
      border: none;
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.3s ease;
      flex: 1;
      min-width: 120px;
    }
    button:hover {
      background-color: var(--hover-bg);
      transform: scale(1.05);
    }
    button:active {
      transform: scale(0.95);
      background-color: var(--active-bg);
    }
    .result-section { margin-top: 20px; }
    .result-table {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 15px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #333;
      border-radius: 10px;
      overflow: hidden;
    }
    th, td {
      padding: 10px;
      text-align: center;
      border: 1px solid #444;
    }
    th {
      background-color: #444;
      font-size: 18px;
      color: var(--accent);
    }
    td { font-size: 16px; color: var(--text-color); }
    .copy-button {
      background-color: #555;
      color: var(--accent);
      border: none;
      padding: 5px 10px;
      font-size: 14px;
      border-radius: 3px;
      cursor: pointer;
      margin-top: 10px;
    }
    .copy-button:hover { background-color: #666; }
    .error { border-color: red !important; }
    /* قسم التسجيل يظهر فقط في تبويب "مقام الراست" */
    #recordingSection {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #444;
      text-align: center;
      display: none;
    }
    #recordingSection button { margin: 5px; min-width: 150px; }
    #recordingSection video,
    #recordingSection audio {
      margin-top: 10px;
      border: 1px solid #444;
      border-radius: 5px;
    }
    .footer {
      margin-top: 30px;
      font-size: 14px;
      color: var(--accent);
      text-align: center;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 1s ease, transform 1s ease;
    }
    .footer.show {
      opacity: 1;
      transform: translateY(0);
    }
    .footer a {
      color: var(--accent);
      text-decoration: none;
    }
    .footer a:hover { text-decoration: underline; }
    @media (max-width: 768px) {
      .result-table { grid-template-columns: 1fr; }
      .button-group { flex-direction: column; }
    }
    /* قسم السلم المقامي */
    .scale-selection {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .scale-btn { padding: 10px 15px; font-size: 16px; }
    .scale-result { margin-top: 20px; }
    .scale-grid {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }
    .scale-card {
      background-color: var(--input-bg);
      padding: 10px 15px;
      border: 1px solid var(--input-border);
      border-radius: 5px;
      text-align: center;
      min-width: 80px;
      transition: transform 0.3s ease;
    }
    .scale-card:hover { transform: scale(1.05); }
    .scale-arrow {
      font-size: 24px;
      color: var(--accent);
      align-self: center;
    }
    .play-note {
      margin-top: 5px;
      background-color: var(--accent);
      border: none;
      color: #000;
      padding: 5px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 14px;
    }
    .play-note:hover { background-color: var(--hover-bg); }
  </style>
</head>
<body>
  <div class="container">
    <div class="tabs">
      <button class="tab-button active" onclick="showTab('nai')">صناعة الناي</button>
      <button class="tab-button" onclick="showTab('kawala')">صناعة الكولة</button>
      <button class="tab-button" onclick="showTab('scale')">مقام الراست من كل الدرجات</button>
    </div>

    <!-- قسم صناعة الناي -->
    <div id="nai" class="tab-content active">
      <div class="section-header">حساب مقاسات الناي - الثقوب والفكوك</div>
      <p class="tooltip">أدخل الطول الإجمالي للناي بالسنتيمتر. ستظهر لك المواقع الدقيقة للثقوب وأطوال الفكوك.</p>
      <label for="length">طول الناي (سم):</label>
      <input type="number" id="length" placeholder="مثال: 53">
      <div class="button-group">
        <button onclick="calculateAll()">حساب</button>
        <button onclick="resetSection('nai')">إعادة تعيين</button>
      </div>
      <div id="naiResults" class="result-section"></div>

      <hr style="margin:20px 0; border: 1px solid #444;">

      <div class="section-header">حساب قطر الرداد بناءً على قطر الخزنة</div>
      <p class="tooltip">أدخل قطر الخزنة بالسنتيمتر لحساب قطر الرداد بدقة.</p>
      <label for="khaznaDiameter">قطر الخزنة (سم):</label>
      <input type="number" id="khaznaDiameter" placeholder="مثال: 1.8">
      <div class="button-group">
        <button onclick="calculateRadadDiameter()">حساب قطر الرداد</button>
        <button onclick="resetInput('khaznaDiameter','radadResult')">إعادة تعيين</button>
      </div>
      <div id="radadResult" class="result-section"></div>
    </div>

    <!-- قسم صناعة الكولة -->
    <div id="kawala" class="tab-content">
      <div class="section-header">حساب أطوال الفكوك وأماكن الثقوب للكولة</div>
      <p class="tooltip">أدخل الطول الإجمالي للكولة بالسنتيمتر لحساب المواقع والأطوال بدقة.</p>
      <label for="totalLength">طول الكولة (سم):</label>
      <input type="number" id="totalLength" placeholder="مثال: 56">
      <div class="button-group">
        <button onclick="calculateKawala()">حساب</button>
        <button onclick="resetSection('kawala')">إعادة تعيين</button>
      </div>
      <div id="kawalaResults" class="result-section"></div>
    </div>

    <!-- قسم السلم المقامي -->
    <div id="scale" class="tab-content">
      <div class="section-header">استكشف مقام الراست من كل الدرجات</div>
      <p class="tooltip">اختر الدرجة الموسيقية لعرض السلم المقامي الخاص بها مع معلومات مفصلة عن النغمات والفواصل.</p>
      <div class="scale-selection">
        <select id="scaleSelect">
          <option value="دو">دو</option>
          <option value="ري بيمول">ري بيمول</option>
          <option value="ري">ري</option>
          <option value="مي بيمول">مي بيمول</option>
          <option value="مي">مي</option>
          <option value="فا">فا</option>
          <option value="صول بيمول">صول بيمول</option>
          <option value="صول">صول</option>
          <option value="لا بيمول">لا بيمول</option>
          <option value="لا">لا</option>
          <option value="سي بيمول">سي بيمول</option>
          <option value="سي">سي</option>
          <option value="علامات الثلاث ارباع">علامات الثلاث ارباع</option>
        </select>
        <button onclick="showScale()" class="tab-button scale-btn">عرض السلم</button>
      </div>
      <div id="scaleResult" class="result-section scale-result"></div>

      <!-- قسم التسجيل يظهر فقط في هذا التبويب -->
      <div id="recordingSection">
        <div class="section-header">التسجيل</div>
        <div>
          <button id="startVideoRecord" onclick="startVideoRecording()">تسجيل فيديو</button>
          <button id="stopVideoRecord" onclick="stopVideoRecording()" disabled>إيقاف تسجيل الفيديو</button>
        </div>
        <video id="videoPreview" autoplay playsinline style="width:100%; max-width:400px; display:none;"></video>
        <br>
        <a id="videoDownloadLink" style="display:none;">تحميل الفيديو</a>
        <hr style="margin:20px 0; border: 1px solid #444;">
        <div>
          <button id="startAudioRecord" onclick="startAudioRecording()">تسجيل صوت</button>
          <button id="stopAudioRecord" onclick="stopAudioRecording()" disabled>إيقاف تسجيل الصوت</button>
        </div>
        <audio id="audioPreview" controls style="display:none; width:100%; max-width:400px;"></audio>
        <br>
        <a id="audioDownloadLink" style="display:none;">تحميل التسجيل الصوتي</a>
      </div>
    </div>

    <div class="footer">
      تصميم وتطوير:
      <a href="https://www.facebook.com/kawana667788/" target="_blank">خالد باشا</a>
      و
      <a href="https://www.facebook.com/profile.php?id=100006318275944" target="_blank">بدر محمد</a>
      - 
      <a href="https://www.facebook.com/groups/501641503562283" target="_blank">جروب تعليم آلة الكولة على الفيسبوك</a>
      <br>
      هذا التطبيق مجاني ولا يسمح ببيعه.
    </div>
  </div>

  <script>
    // ---------------------- الجزء المتعلق بالصوت والنغمات ----------------------
    var audioPlayers = {};
    var currentPlaying = null;
    var currentButton = null;
    // Global AudioContext يُنشأ عند الحاجة
    var globalAudioContext = null;
    // المتغير الذي يحمل مصدر صوت النغمة (MediaElementAudioSourceNode)
    var currentToneSource = null;

    // بيانات سلالم المقامات وروابط الأصوات (نفسها كما في النسخة السابقة)
    const scales = {
      "دو": "دو - ري - مي نصف بيمول - فا - صول - لا - سي نصف بيمول - دو",
      "ري بيمول": "ري بيمول - مي بيمول - فا نصف بيمول - صول بيمول - لا بيمول - سي بيمول - دو نصف بيمول - ري بيمول",
      "ري": "ري - مي - فا نصف دييز - صول - لا - سي - دو نصف دييز - ري",
      "مي بيمول": "مي بيمول - فا - صول نصف بيمول - لا بيمول - سي بيمول - دو - ري نصف بيمول - مي بيمول",
      "مي": "مي - فا دييز - صول نصف دييز - لا - سي - دو دييز - ري نصف دييز - مي",
      "فا": "فا - صول - لا نصف بيمول - سي بيمول - دو - ري - مي نصف بيمول - فا",
      "صول بيمول": "صول بيمول - لا بيمول - لا نصف دييز - سي - ري بيمول - مي بيمول - فا نصف بيمول - صول بيمول",
      "صول": "صول - لا - سي نصف بيمول - دو - ري - مي - فا نصف دييز - صول",
      "لا بيمول": "لا بيمول - سي بيمول - دو نصف بيمول - ري بيمول - مي بيمول - فا - صول نصف بيمول - لا بيمول",
      "لا": "لا - سي - دو نصف دييز - ري - مي - فا دييز - صول نصف دييز - لا",
      "سي بيمول": "سي بيمول - دو - ري نصف بيمول - مي بيمول - فا - صول - لا نصف بيمول - سي بيمول",
      "سي": "سي - دو دييز - ري نصف دييز - مي - فا دييز - صول دييز - لا نصف دييز - سي",
      "علامات الثلاث ارباع": "ري نصف بيمول - دو نصف دييز - مي نصف بيمول - فا نصف دييز - صول نصف بيمول - لا نصف بيمول - لا نصف دييز - سي نصف بيمول - سي نصف دييز"
    };

    const noteAudioMapping = {
      "دو": "https://dl.dropboxusercontent.com/scl/fi/ody6hdacpjd31kxm37cbc/.mp3?rlkey=r74goqb6l6ll07ham3pytufkp",
      "دو دييز": "https://dl.dropboxusercontent.com/scl/fi/sbiblojbrx9hnvxmfqk18/.mp3?rlkey=ey7yp6k60402fje5r49bx8qvf",
      "دو نصف دييز": "https://dl.dropboxusercontent.com/scl/fi/ib8sd1onvt5g477lvrl1f/.mp3?rlkey=tsb4dxq6gw4jtlcteb8cla2x7",
      "دو نصف بيمول": "https://dl.dropboxusercontent.com/scl/fi/88wtah8498a8fgrrvt5xt/.mp3?rlkey=kibu0qlj4t2o2fz80lmx8c4pj",
      "ري بيمول": "https://dl.dropboxusercontent.com/scl/fi/yy3ifpy2142xq3xu4l1d8/.mp3?rlkey=dpr4me512o40x2c9fasznpg79",
      "ري": "https://dl.dropboxusercontent.com/scl/fi/8pxldyaees75u1spht862/.mp3?rlkey=ccn2nwzs85crys03yeiqcujpa",
      "ري نصف بيمول": "https://dl.dropboxusercontent.com/scl/fi/vmdn5k03qjgig5ylmj6ac/.mp3?rlkey=hh4f1rb5yivcdhfgii9m9tltz",
      "ري دييز": "https://dl.dropboxusercontent.com/scl/fi/0j8h4qt97z5a36pzl7g78/.mp3?rlkey=z9emnyr1m263d5uokbdvluzb7",
      "ري نصف دييز": "https://dl.dropboxusercontent.com/scl/fi/wko15s4ruckimoykr6mmt/.mp3?rlkey=ribtzeb7a4rpczvpqmesuk8aq",
      "مي بيمول": "https://dl.dropboxusercontent.com/scl/fi/0j8h4qt97z5a36pzl7g78/.mp3?rlkey=z9emnyr1m263d5uokbdvluzb7",
      "مي": "https://dl.dropboxusercontent.com/scl/fi/xc15925yrwmr0qu8enqc2/.mp3?rlkey=kd75wwwn5gqdm86repioemyus",
      "مي نصف بيمول": "https://dl.dropboxusercontent.com/scl/fi/b2903mcw6rnmmx3uwqhon/.mp3?rlkey=wef2w2a3xipapzz8fh4mbgc0b",
      "فا": "https://dl.dropboxusercontent.com/scl/fi/40aj5g1g1bq3ocz5baze7/.mp3?rlkey=3uafizgrgpli4xh87hijjugh7",
      "فا دييز": "https://dl.dropboxusercontent.com/scl/fi/6tyfjl7wzjeax2hsbei91/.mp3?rlkey=6nrf2cix5j3d0i4eyqs03ldlz",
      "فا نصف بيمول": "https://dl.dropboxusercontent.com/scl/fi/yxjrb33ysgcbdypd9zznx/.mp3?rlkey=ftmy2ws9r7go3uiebtqv0qh0g",
      "فا نصف دييز": "https://dl.dropboxusercontent.com/scl/fi/87jluxjsi16iz3ip5lrc3/.mp3?rlkey=fza7syc9v4h4zunsa34np37ay",
      "صول بيمول": "https://dl.dropboxusercontent.com/scl/fi/6tyfjl7wzjeax2hsbei91/.mp3?rlkey=6nrf2cix5j3d0i4eyqs03ldlz",
      "صول": "https://dl.dropboxusercontent.com/scl/fi/a38fetx5cz0bvkuc3nfb3/.mp3?rlkey=cqkvyi6mztugsgqtp9jgz3cd6",
      "صول دييز": "https://dl.dropboxusercontent.com/scl/fi/30d6via79cwrd4imio90x/.mp3?rlkey=0le22kqx0ae3tpf3nhbme0onc",
      "صول نصف دييز": "https://dl.dropboxusercontent.com/scl/fi/exv3wirafp55qms58tuig/.mp3?rlkey=qbzc80k5gczl2j0gbosrjmhky",
      "صول نصف بيمول": "https://dl.dropboxusercontent.com/scl/fi/j2va1j0ujuka43pcyu4j1/.mp3?rlkey=x7j3fwyslu8qe4uo8n1t9nkne",
      "لا بيمول": "https://dl.dropboxusercontent.com/scl/fi/30d6via79cwrd4imio90x/.mp3?rlkey=0le22kqx0ae3tpf3nhbme0onc",
      "لا": "https://dl.dropboxusercontent.com/scl/fi/3aiehhnhxgv2drmxdtl5i/.mp3?rlkey=0kiewx92otb3hct1zn64s8nj0",
      "لا دييز": "https://dl.dropboxusercontent.com/scl/fi/zmitrsq6ezkb3ojb142lv/.mp3?rlkey=1832ahcpn7hwwlyw2d9l8xr27",
      "لا نصف بيمول": "https://dl.dropboxusercontent.com/scl/fi/pznwkre0vjncoyzfzw2io/.mp3?rlkey=w1jnlz8qu93aj8z46v1q7m1eq",
      "لا نصف دييز": "https://dl.dropboxusercontent.com/scl/fi/ls3nxm3i5lya8w76of9dr/.mp3?rlkey=uq7poj9svl0javs9adgcernkn",
      "سي بيمول": "https://dl.dropboxusercontent.com/scl/fi/zmitrsq6ezkb3ojb142lv/.mp3?rlkey=1832ahcpn7hwwlyw2d9l8xr27",
      "سي": "https://dl.dropboxusercontent.com/scl/fi/lrqxlgtf2xgu6fwqeo3qx/.mp3?rlkey=88r2z4dqix2wl9inb9abjp3i1",
      "سي نصف بيمول": "https://dl.dropboxusercontent.com/scl/fi/1yy51ldrmkupp6voqzxcv/.mp3?rlkey=j5td5yffe23v3app91fobtiq0",
      "سي نصف دييز": "https://dl.dropboxusercontent.com/scl/fi/rgf4qmqwxuoszh9iycy3j/.mp3?rlkey=88bpff50f5b41mnf084aybl7i"
    };

    // دالة تبديل تشغيل/إيقاف الصوت مع استخدام Web Audio API
    function togglePlay(btn, note) {
      // إذا كانت النغمة قيد التشغيل بالفعل، قم بإيقافها وإعادة تهيئة المصدر
      if (currentPlaying === note && audioPlayers[note] && !audioPlayers[note].paused) {
        audioPlayers[note].pause();
        audioPlayers[note].currentTime = 0;
        if (currentToneSource) {
          try { currentToneSource.disconnect(); } catch(e) { console.error(e); }
          currentToneSource = null;
        }
        btn.innerText = "▶";
        currentPlaying = null;
        currentButton = null;
      } else {
        // إذا كانت هناك نغمة أخرى تعمل، أوقفها
        if (currentPlaying && audioPlayers[currentPlaying] && !audioPlayers[currentPlaying].paused) {
          audioPlayers[currentPlaying].pause();
          audioPlayers[currentPlaying].currentTime = 0;
          if (currentToneSource) {
            try { currentToneSource.disconnect(); } catch(e) { console.error(e); }
            currentToneSource = null;
          }
          if (currentButton) { currentButton.innerText = "▶"; }
        }
        // إنشاء AudioContext إذا لم يكن موجوداً، واستئنافه إذا كان معلقاً
        if (!globalAudioContext) {
          globalAudioContext = new AudioContext();
        }
        if (globalAudioContext.state === "suspended") {
          globalAudioContext.resume();
        }
        // التأكد من وجود العنصر الصوتي للنغمة
        if (!audioPlayers[note]) {
          audioPlayers[note] = new Audio(noteAudioMapping[note]);
        }
        // يُمكنك تعديل الخاصية التالية (muted) إذا كان ذلك يمنع ظهور الصوت؛ في بعض الأجهزة قد تحتاج لإزالة هذه الخاصية
        audioPlayers[note].muted = true;
        try {
          if (currentToneSource) { currentToneSource.disconnect(); }
          currentToneSource = globalAudioContext.createMediaElementSource(audioPlayers[note]);
          // نوصّل المصدر إلى وجهة الصوت (يمكنك تعديل هذا إذا أردت عدم سماع النغمة مباشرة)
          currentToneSource.connect(globalAudioContext.destination);
        } catch(e) {
          console.error("خطأ في إنشاء مصدر النغمة:", e);
        }
        audioPlayers[note].play();
        btn.innerText = "■";
        currentPlaying = note;
        currentButton = btn;
      }
    }

    // عرض السلم المقامي مع البطاقات وأزرار تشغيل النغمات
    function showScale() {
      const selectedScale = document.getElementById("scaleSelect").value;
      const scaleResultDiv = document.getElementById("scaleResult");
      const scaleString = scales[selectedScale] || "السلم غير متوفر";
      const notes = scaleString.split(" - ");
      let html = `<div class="scale-grid">`;
      notes.forEach((note, index) => {
        html += `
          <div class="scale-card">
            <div class="note-index">${index + 1}</div>
            <div class="note-name">${note}</div>
            <button class="play-note" onclick="togglePlay(this, '${note}')">▶</button>
          </div>`;
        if (index < notes.length - 1) {
          html += `<div class="scale-arrow">→</div>`;
        }
      });
      html += `</div>`;
      scaleResultDiv.innerHTML = html;
    }

    // تبديل علامات التبويب وإظهار قسم التسجيل فقط في تبويب "مقام الراست"
    function showTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
      document.querySelector(`button[onclick="showTab('${tabName}')"]`).classList.add('active');
      if(tabName === 'scale'){
        document.getElementById('recordingSection').style.display = 'block';
      } else {
        document.getElementById('recordingSection').style.display = 'none';
      }
    }

    // دوال التحقق من المدخلات (لحساب الناي والكولة) تبقى كما هي...
    function validateInput(inputId) {
      const input = document.getElementById(inputId);
      if (!input.value || parseFloat(input.value) <= 0) {
        input.classList.add('error');
        return false;
      } else {
        input.classList.remove('error');
        return true;
      }
    }
    // (يمكنك استخدام نفس دوال حساب الناي، حساب الرداد، حساب الكولة، نسخ النتائج، وإعادة التعيين كما في النسخة الأصلية)

    // ---------------------- الجزء الخاص بالتسجيل (فيديو وصوت) ----------------------
    var mediaRecorderVideo;
    var recordedChunksVideo = [];
    var mediaRecorderAudio;
    var recordedChunksAudio = [];

    // بدء تسجيل الفيديو مع دمج صوت المايك والنغمة
    async function startVideoRecording() {
      try {
        if (!globalAudioContext) { globalAudioContext = new AudioContext(); }
        // الحصول على تيار المايكروفون والفيديو
        const micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const cameraStream = await navigator.mediaDevices.getUserMedia({ video: true });
        // إنشاء مصدر صوت من المايكروفون وتوصيله إلى وجهة التسجيل
        const micSource = globalAudioContext.createMediaStreamSource(micStream);
        const recordingDestination = globalAudioContext.createMediaStreamDestination();
        micSource.connect(recordingDestination);
        // إذا كانت نغمة مشغلة، توصيل مصدرها إلى وجهة التسجيل
        if (currentToneSource) {
          currentToneSource.connect(recordingDestination);
        }
        // دمج تيار الصوت والفييديو
        const combinedStream = new MediaStream();
        recordingDestination.stream.getAudioTracks().forEach(track => combinedStream.addTrack(track));
        cameraStream.getVideoTracks().forEach(track => combinedStream.addTrack(track));
        const videoPreview = document.getElementById("videoPreview");
        videoPreview.muted = true; // كتم المعاينة لتفادي الصدى
        videoPreview.style.display = "block";
        videoPreview.srcObject = combinedStream;
        recordedChunksVideo = [];
        mediaRecorderVideo = new MediaRecorder(combinedStream);
        mediaRecorderVideo.ondataavailable = function(e) {
          if(e.data && e.data.size > 0) {
            recordedChunksVideo.push(e.data);
          }
        };
        mediaRecorderVideo.onstart = function() {
          document.getElementById("startVideoRecord").innerText = "Recording...";
        };
        mediaRecorderVideo.onstop = function() {
          document.getElementById("startVideoRecord").innerText = "تسجيل فيديو";
          const blob = new Blob(recordedChunksVideo, { type: "video/webm" });
          const url = URL.createObjectURL(blob);
          const downloadLink = document.getElementById("videoDownloadLink");
          downloadLink.href = url;
          downloadLink.download = "recorded_video.webm";
          downloadLink.style.display = "block";
          downloadLink.innerText = "تحميل الفيديو";
        };
        mediaRecorderVideo.start();
        document.getElementById("startVideoRecord").disabled = true;
        document.getElementById("stopVideoRecord").disabled = false;
      } catch (err) {
        console.error("خطأ في بدء تسجيل الفيديو:", err);
      }
    }

    function stopVideoRecording() {
      if (mediaRecorderVideo && mediaRecorderVideo.state !== "inactive") {
        mediaRecorderVideo.stop();
        document.getElementById("startVideoRecord").disabled = false;
        document.getElementById("stopVideoRecord").disabled = true;
        const videoPreview = document.getElementById("videoPreview");
        if(videoPreview.srcObject) {
          videoPreview.srcObject.getTracks().forEach(track => track.stop());
        }
        videoPreview.style.display = "none";
      }
    }

    async function startAudioRecording() {
      try {
        if (!globalAudioContext) { globalAudioContext = new AudioContext(); }
        const micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const micSource = globalAudioContext.createMediaStreamSource(micStream);
        const recordingDestination = globalAudioContext.createMediaStreamDestination();
        micSource.connect(recordingDestination);
        if (currentToneSource) {
          currentToneSource.connect(recordingDestination);
        }
        recordedChunksAudio = [];
        mediaRecorderAudio = new MediaRecorder(recordingDestination.stream);
        mediaRecorderAudio.ondataavailable = function(e) {
          if(e.data && e.data.size > 0) {
            recordedChunksAudio.push(e.data);
          }
        };
        mediaRecorderAudio.onstart = function() {
          document.getElementById("startAudioRecord").innerText = "Recording...";
        };
        mediaRecorderAudio.onstop = function() {
          document.getElementById("startAudioRecord").innerText = "تسجيل صوت";
          const blob = new Blob(recordedChunksAudio, { type: "audio/webm" });
          const url = URL.createObjectURL(blob);
          const audioPreview = document.getElementById("audioPreview");
          audioPreview.src = url;
          audioPreview.style.display = "block";
          const downloadLink = document.getElementById("audioDownloadLink");
          downloadLink.href = url;
          downloadLink.download = "recorded_audio.webm";
          downloadLink.style.display = "block";
          downloadLink.innerText = "تحميل التسجيل الصوتي";
        };
        mediaRecorderAudio.start();
        document.getElementById("startAudioRecord").disabled = true;
        document.getElementById("stopAudioRecord").disabled = false;
      } catch (err) {
        console.error("خطأ في بدء تسجيل الصوت:", err);
      }
    }

    function stopAudioRecording() {
      if (mediaRecorderAudio && mediaRecorderAudio.state !== "inactive") {
        mediaRecorderAudio.stop();
        document.getElementById("startAudioRecord").disabled = false;
        document.getElementById("stopAudioRecord").disabled = true;
      }
    }

    // إظهار الفوتر بعد تحميل الصفحة
    document.addEventListener("DOMContentLoaded", function() {
      setTimeout(() => {
        document.querySelector('.footer').classList.add('show');
      }, 1000);
    });
  </script>
</body>
</html>
